<html>
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript">

		var syncPeriod = 60000;
		var syncTabServiceUrl = "http://synctabapp.khmelyuk.com/api";

		var refreshInterval;

		function load() {
			if (needLogin()) {
			 	chrome.tabs.create({url: 'login.html'});
			}
			else {
				refreshInterval = setInterval(refreshSyncedTabs, syncPeriod);
			}
		}

		function authorize(email, password, callback) {
			$.post(syncTabServiceUrl + "/authorize", {email: email, password: password}, 
				function(json, textStatus) {
					if (json.status) {
						login(email, json.token)
						callback(true);
					}
					else {
						callback(false);
					}
				}
			);
		}

		function needLogin() {
			var token = localStorage['token'];
			return token == null || token == undefined;
		}

		function login(email, token) {
			localStorage['email'] = email;
			localStorage['token'] = token;

			refreshSyncedTabs();
			refreshInterval = setInterval(refreshSyncedTabs, syncPeriod);
		}

		function getUsername() {
			return localStorage['email'];
		}

		function logout(showLoginPage) {
			// TODO - logout remotely 
			clearSession();

			if (showLoginPage) {
				chrome.tabs.create({url: 'login.html'});
			}
		}

		function clearSession() {
			clearInterval(refreshInterval);
			delete localStorage['token'];
			delete localStorage['email'];
		}

		function refreshSyncedTabs() {
			if (!needLogin()) {
					
				// get last sync timestamp
				var timestamp = localStorage['lastSyncDate'];
				if (timestamp == undefined) {
					var yesterday = new Date();
					yesterday.setDate(yesterday.getDate() - 1);
					timestamp = yesterday.getTime();
				}

				var token = localStorage['token'];
				$.ajax({
					url: syncTabServiceUrl + "/getSharedTabs", 
					dataType: 'json', 
					data: {'ts': timestamp, 'token': token},
					success: function(json, textStatus, jqXHR) {
						if (jqXHR.status == 200) {
							if (json.status) {
								var tabs = json.tabs;
								if (tabs.length > 0) {
									for (var i = 0; i < tabs.length; i++) {
										var tab = tabs[i];
										chrome.tabs.create({
											url: tab.link,
											selected: false,
											pinned: false
										})
									}
									webkitNotifications.createNotification(
										"icon48.png", "SyncTab: new tabs", 
										tabs.length + " shared tabs were opened"
									).show();

									// save sync timestamp
									localStorage['lastSyncDate'] = new Date().getTime();
								}
							}
						}
					},
					error: function(jqXHR) {
						if (jqXHR.status == 401) {
							logout(true);
						}
					}
				});
			}
			else {
				clearInterval(refreshInterval);
			}
		}

		load();

	</script>
</html>