<html>
	<script type="text/javascript">

		var syncPeriod = 60000;
		var tabsList = [];

		function load() {
			refreshSyncedTabs();
			setInterval(refreshSyncedTabs, syncPeriod);
		}

		function refreshSyncedTabs() {
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
					var tabs = JSON.parse(xhr.responseText);
					if (tabs.length > 0) {
						for (var i = 0; i < tabs.length; i++) {
							var tab = tabs[i];
							tabsList.push(tab);
						}
						
						if (tabsList.length > 0) {
							chrome.browserAction.setBadgeText({text: "" + tabsList.length});
							chrome.browserAction.setBadgeBackgroundColor({color: [120, 145, 223, 223]})
						}
						else {
							chrome.browserAction.setBadgeText({text: ""});
							chrome.browserAction.setBadgeBackgroundColor({color: []})
						}
					}
				}
			}


			// get last sync timestamp
			var timestamp = localStorage['lastSyncDate'];
			if (timestamp == undefined) {
				timestamp = 0;
			}

			// TODO - remove
			timestamp = 0;

			xhr.open("GET", "http://localhost:8080/synctab-server/api/getSharedTabs?since=" + timestamp, true);
			xhr.send();


			// FIXME - get a date always for GMT
			// save sync timestamp
			//localStorage['lastSyncDate'] = new Date().getTime();
		}

		function getSharedTabs() {
			return tabsList;
		}

		load();


		// chrome.extension.onConnect.addListener(function(port) {
		// 	var tab = port.sender.tab;

		// 	port.onMessage.addListener(function(info) {
		// 		alert(tab.url + " " + info.title);
		// 	});
		// });
		// chrome.browseAction.onClicked.addListener(function() {
		// 	chrome.tabs.executeScript(null, {file: "page_info.js"});

		// 	// chrome.browserAction.setIcon({path:"icon" + current + ".png"});
		// });
	</script>
</html>