<html>
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript" src="synctab.js"></script>
	<script type="text/javascript">

		var refreshInterval;

		function load() {
			SyncTab.initOptions();

			if (SyncTab.needLogin()) {
			 	SyncTab.openLoginPage();
			}
			else {
				startRefreshWithInterval();
			}
		}

		function login() {
			refreshSyncedTabs();
			startRefreshWithInterval();
		}

		function logout(showLoginPage) {
			SyncTab.logout();
			stopRefreshWithInterval();

			if (showLoginPage) {
				SyncTab.openLoginPage();
			}
		}

		function refreshSyncedTabs() {
			if (!SyncTab.needLogin()) {
				loadNewTabs();
			}
			else {
				stopRefreshWithInterval();
			}
		}

		function loadNewTabs() {
			var token = SyncTab.options.token.get()
			var timestamp = SyncTab.options.lastSyncDate.get();

			// if checked for first time, than set date = yesterday
			if (timestamp == undefined) {
				var yesterday = new Date();
				yesterday.setDate(yesterday.getDate() - 1);
				timestamp = yesterday.getTime();
			}

			$.ajax({
				url: SyncTab.apiUrl + "/getSharedTabs", 
				dataType: 'json', 
				data: {'ts': timestamp, 'token': token},
				success: function(json, textStatus, jqXHR) {
					if (jqXHR.status == 200) {
						if (json.status) {
							SyncTab.handleNewTabs(json.tabs);
						}
					}
				},
				error: function(jqXHR) {
					if (jqXHR.status == 401) {
						logout(true);
					}
				}
			});
		}

		function optionsChanged() {
			stopRefreshWithInterval();
			startRefreshWithInterval();
		}

		function startRefreshWithInterval() {
			refreshInterval = setInterval(
				refreshSyncedTabs, 
				parseInt(SyncTab.options.refreshInterval.get()));
			console.log("started refresh interval ", parseInt(SyncTab.options.refreshInterval.get()));
		}

		function stopRefreshWithInterval() {
			if (refreshInterval) {
				console.log("clear refresh interval.");
				clearInterval(refreshInterval);
			}
		}

		load();

	</script>
</html>