<html>
	<script type="text/javascript">

		var syncPeriod = 60000;
		var syncTabServiceUrl = "http://localhost:8080/synctab-server";

		function load() {
			refreshSyncedTabs();
			setInterval(refreshSyncedTabs, syncPeriod);
		}

		function refreshSyncedTabs() {
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
					var tabs = JSON.parse(xhr.responseText);
					if (tabs.length > 0) {
						for (var i = 0; i < tabs.length; i++) {
							var tab = tabs[i];
							chrome.tabs.create({
								url: tab.link,
								selected: false,
								pinned: false
							})
						}
						webkitNotifications.createNotification(
							"icon48.png", "SyncTab: new tabs", 
							tabs.length + " shared tabs were opened"
						).show();
					}
				}
			}


			// get last sync timestamp
			var timestamp = localStorage['lastSyncDate'];
			if (timestamp == undefined) {
				var yesterday = new Date();
				yesterday.setDate(yesterday.getDate() - 1);
				timestamp = yesterday.getTime();
			}

			xhr.open("GET", syncTabServiceUrl + "/api/getSharedTabs?since=" + timestamp, true);
			xhr.send();


			// FIXME - get a date always for GMT
			// save sync timestamp
			localStorage['lastSyncDate'] = new Date().getTime();
		}

		load();

	</script>
</html>